<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>game1</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <style>
        canvas {
            border: 2px solid rgb(27, 10, 99);
            display: block;
        }
        
        button {
            background-color: rgb(99, 199, 238);
            display: inline-block;
            margin: 10px 2px;
        }
    </style>
</head>

<body>
    <script>
        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {
                        y: 300
                    },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);
        var platforms; // --- green pieces of the ground in the air, from which we'll do the Group
        var player; // == our dude 
        var rubies; // --- things to collect 
        var score = 0;
        var scoreText;
        var bombs;
        var gameOver = false;
        var myMusic;

        //------Music --------
        function Sound(src) {
            this.sound = document.createElement("audio");
            this.sound.src = src;
            this.sound.setAttribute("preload", "auto");
            this.sound.setAttribute("controls", "none");
            this.sound.style.display = "none";
            document.body.appendChild(this.sound);
            this.play = function() {
                this.sound.play();
                this.sound.setAttribute('loop', true);
            }
            this.stop = function() {
                this.sound.pause();
            }
        }
        myMusic = new Sound('SpotLight.mp3');
        // myMusic.play();

        function preload() {

            this.load.image('sky', 'assets/sky.png');
            this.load.image('star', 'assets/star.png');
            this.load.image('ground', 'assets/platform.png');
            this.load.image('bomb', 'assets/bomb.png');

            this.load.spritesheet('dude', 'assets/dude.png', {
                frameWidth: 32,
                frameHeight: 48
            });
            this.load.image('ruby', 'assets/ruby.png');
        }


        function create() {
            this.add.image(0, 0, "sky").setOrigin(0, 0);

            platforms = this.physics.add.staticGroup();
            platforms.create(400, 568, "ground").setScale(2).refreshBody(); //--ground

            platforms.create(600, 400, "ground");
            platforms.create(50, 250, "ground");
            platforms.create(750, 220, "ground");
            //---the stars )))
            this.add.image(200, 50, "star");
            this.add.image(100, 100, "star");
            this.add.image(400, 50, "star");
            this.add.image(450, 110, "star");
            this.add.image(350, 120, "star");
            this.add.image(600, 30, "star");
            this.add.image(750, 70, "star");

            //---rubies to collect
            rubies = this.physics.add.group({
                key: "ruby",
                repeat: 11,
                setXY: {
                    x: 12,
                    y: 0,
                    stepX: 70
                }
            });

            rubies.children.iterate(function(child) {
                child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
            });
            this.physics.add.collider(rubies, platforms); //--- for the rubies not to fall down through the grounds


            // -----player------------
            player = this.physics.add.sprite(100, 350, "dude"); //--- our dude and sprite frames shown
            player.setBounce(0.4);
            player.setCollideWorldBounds(true);

            //--- this is where we add some check for collisions
            this.physics.add.collider(player, platforms); // - --to step over platforms

            this.physics.add.overlap(player, rubies, collectRuby, null, this); // --here we check if the Dude overlaps the rubies
            function collectRuby(player, ruby) {
                ruby.disableBody(true, true); //--to remove a ruby from the rubies Group
                score += 10; //------to change the score
                scoreText.setText("Score: " + score);

                //-------------here we check the number of rubies, if there are none, we need to respawn them
                if (rubies.countActive(true) === 0) {
                    rubies.children.iterate(function(child) {
                        child.enableBody(true, child.x, 0, true, true); //--we give position Y =0 to fall them again
                    });
                    //----we give the initial coords and speed to bombs
                    var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

                    var bomb = bombs.create(x, 16, "bomb");
                    bomb.setBounce(0.95);
                    bomb.setCollideWorldBounds(true);
                    bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                }
                return score;
            }

            //----bombs------
            bombs = this.physics.add.group();

            this.physics.add.collider(bombs, platforms);

            this.physics.add.collider(player, bombs, hitBomb, null, this);

            function hitBomb(player, bomb) {
                this.physics.pause();

                player.setTint(0xff0000);

                player.anims.play("turn");

                gameOver = true;
                myMusic.stop();
                localStorage.setItem('score', JSON.stringify(score));
                alert('Your Score ' + score);
            }
            //------------------the dude's looks for movements
            this.anims.create({
                key: "left",
                frames: this.anims.generateFrameNumbers("dude", {
                    start: 0,
                    end: 3
                }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: "turn",
                frames: [{
                    key: "dude",
                    frame: 4
                }],
                frameRate: 5
            });

            this.anims.create({
                key: "right",
                frames: this.anims.generateFrameNumbers("dude", {
                    start: 5,
                    end: 8
                }),
                frameRate: 10,
                repeat: -1
            });
            //--initial score text block, Courier by default
            scoreText = this.add.text(16, 16, "Score: 0", {
                fontSize: "32px",
                fill: "#640000"
            });
        }

        function update() {

            var cursors = this.input.keyboard.createCursorKeys();

            // ---the control of the dude
            if (cursors.left.isDown) {
                player.setVelocityX(-160);

                player.anims.play("left", true);
            } else if (cursors.right.isDown) {
                player.setVelocityX(160);

                player.anims.play("right", true);
            } else {
                player.setVelocityX(0);

                player.anims.play("turn");
            }

            if (
                cursors.up.isDown &&
                player.body.touching.down
            ) {
                player.setVelocityY(-330);
            }
        }
    </script>
    <audio src="SpotLight.mp3" preload="auto" controls="none" style="display: none;"></audio>
    <br>
    <button onclick="myMusic.play()">Music ON</button>
    <button onclick="myMusic.stop()">Music OFF</button>

</body>

</html>